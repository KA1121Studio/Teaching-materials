<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ANDROID URL Test</title>
<style>
  body { margin:0; padding:0; background:#111; color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
  video { width: 90%; max-width:600px; background:#000; }
</style>
</head>
<body>

<h2>ANDROID client test</h2>
<video id="video" controls muted autoplay playsinline></video>
<audio id="audio" style="display:none"></audio>

<script>
const videoEl = document.getElementById("video");
const audioEl = document.getElementById("audio");

// URL末尾からvideoIdを取得する関数
function getVideoIdFromURL() {
  const path = window.location.pathname; // /niKAylKNIEI など
  const match = path.match(/\/([a-zA-Z0-9_-]{11})$/); // YouTube IDは11文字
  return match ? match[1] : null;
}

const videoId = getVideoIdFromURL() || "niKAylKNIEI"; // 取得できなければデフォルト

if (!videoId) console.error("videoIdが取得できません");

async function load() {
  const res = await fetch(`/video?id=${videoId}`);
  const data = await res.json();

  if (!data.video || !data.audio) return console.error("動画または音声URLなし");

  videoEl.src = "/proxy?url=" + encodeURIComponent(data.video);
  audioEl.src = "/proxy?url=" + encodeURIComponent(data.audio);

  // videoの再生に同期
  videoEl.addEventListener("play", () => audioEl.play().catch(()=>{}));
  videoEl.addEventListener("pause", () => audioEl.pause());
  videoEl.addEventListener("seeking", () => audioEl.currentTime = videoEl.currentTime);
  videoEl.addEventListener("ratechange", () => audioEl.playbackRate = videoEl.playbackRate);

  // エラー監視
  videoEl.addEventListener('error', e => console.error('video error', e));
  audioEl.addEventListener('error', e => console.error('audio error', e));
}

load();
</script>

</body>
</html>
